@{
  Layout = "";
  ViewBag.Title = "ArcGIS GeoCoding Tests";
}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewBag.Title</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/lib/fontawesome/css/all.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/WHLSite.styles.css" asp-append-version="true" />
  </head>
  <body>
    <div class="container">
      <div class="text-left mt-32">
        <form class="form whl-form-test-arcgis" name="frmTestArcGIS" id="frmTestArcGIS" method="post" novalidate="novalidate">
          <div class="card border-0 shadow-lg">
            <div class="card-body">
              <h4 class="text-secondary whl-card-title">@ViewBag.Title</h4>
              <div class="row mb-3">
                <div class="col-xs-12 col-md-6">
                  <div class="form-group form-group-sm">
                    <label class="form-label small fw-bolder" for="txtStreetLine1">Line 1 <span class="text-danger">*</span></label><br />
                    <input type="text" class="form-control form-control-sm whl-formfield-required-validation whl-formfield-required-save whl-formfield-streetline1" id="txtStreetLine1" name="txtStreetLine1" maxlength="100" />
                  </div>
                  <div class="form-group form-group-sm">
                    <label class="form-label small" for="txtStreetLine2">Line 2</label><br />
                    <input type="text" class="form-control form-control-sm whl-formfield-streetline2" id="txtStreetLine2" name="txtStreetLine2" maxlength="100" />
                  </div>
                  <div class="form-group form-group-sm">
                    <label class="form-label small" for="txtStreetLine3">Line 3</label><br />
                    <input type="text" class="form-control form-control-sm whl-formfield-streetline3" id="txtStreetLine3" name="txtStreetLine3" maxlength="100" />
                  </div>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-xs-12 col-md-3">
                  <div class="form-group form-group-sm">
                    <label class="form-label small fw-bolder" for="txtCity">City <span class="text-danger">*</span></label><br />
                    <input type="text" class="form-control form-control-sm whl-formfield-required-validation whl-formfield-required-save whl-formfield-city" id="txtCity" name="txtCity" maxlength="100" />
                  </div>
                </div>
                <div class="col-xs-12 col-md-1">
                  <div class="form-group form-group-sm">
                    <label class="form-label small fw-bolder" for="txtState">State <span class="text-danger">*</span></label><br />
                    <input type="text" class="form-control form-control-sm whl-formfield-required-validation whl-formfield-required-save whl-formfield-state" id="txtState" name="txtState" maxlength="20" />
                  </div>
                </div>
                <div class="col-xs-12 col-md-2">
                  <div class="form-group form-group-sm">
                    <label class="form-label small fw-bolder" for="txtZipCode">Zip Code <span class="text-danger">*</span></label><br />
                    <input type="text" class="form-control form-control-sm whl-formfield-required-validation whl-formfield-required-save whl-formfield-zipcode" id="txtZipCode" name="txtZipCode" maxlength="5" />
                  </div>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-xs-12 col-md-3">
                  <div class="form-group form-group-sm">
                    <label class="form-label small fw-bolder" for="txtCounty">County <span class="text-danger">*</span></label><br />
                    <input type="text" class="form-control form-control-sm whl-formfield-required-save whl-formfield-county" id="txtCounty" name="txtCounty" maxlength="100" disabled="disabled" aria-disabled="disabled" />
                  </div>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-xs-12 col-md-3">
                  <div class="form-group form-group-sm">
                    <label class="form-label small fw-bolder" for="txtLongitude">Longitude <span class="text-danger">*</span></label><br />
                    <input type="text" class="form-control form-control-sm whl-formfield-required-save whl-formfield-longitude" id="txtLongitude" name="txtLongitude" maxlength="32" disabled="disabled" aria-disabled="disabled" />
                  </div>
                </div>
                <div class="col-xs-12 col-md-3">
                  <div class="form-group form-group-sm">
                    <label class="form-label small fw-bolder" for="txtLatitude">Latitude <span class="text-danger">*</span></label><br />
                    <input type="text" class="form-control form-control-sm whl-formfield-required-save whl-formfield-latitude" id="txtLatitude" name="txtLatitude" maxlength="32" disabled="disabled" aria-disabled="disabled" />
                  </div>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-xs-12 col-md-6">
                  <div class="form-group form-group-sm">
                    <label class="form-label small fw-bolder" for="rdoMapType">Map Type <span class="text-danger">*</span></label><br />
                    <div class="form-check">
                      <input type="radio" class="form-check-input whl-formfield-maptype" id="rdoMapTypeWebView" name="rdoMapType" value="WEBMAP" checked="checked" aria-checked="true" />
                      <label class="form-check-label" for="rdoMapTypeWebView">Web View</label>
                    </div>
                    <div class="form-check">
                      <input type="radio" class="form-check-input whl-formfield-maptype" id="rdoMapTypeEmbedMap" name="rdoMapType" value="EMBEDMAP" />
                      <label class="form-check-label" for="rdoMapTypeEmbedMap">Embedded Map</label>
                    </div>
                  </div>
                </div>
              </div>

              <iframe class="w-100 mt-32 whl-iframe-address-map mb-3" style="min-height: 480px; display: none;" src=""></iframe>
            </div>
            <div class="card-footer">
              <button type="button" class="btn btn-sm btn-outline-secondary whl-action-cancel-address" title="Cancel" aria-label="Cancel">Cancel</button>
              <button type="button" class="btn btn-sm btn-outline-primary whl-action-validate-address" title="Validate" aria-label="Validate">Validate</button>
              <button type="button" class="btn btn-sm btn-outline-secondary whl-action-reset-address" title="Reset" aria-label="Reset" style="display: none;">Reset</button>
              <button type="submit" class="btn btn-sm btn-outline-primary whl-action-save-address" title="Save" aria-label="Save" style="display: none;">Save</button>
              <label class="fs-6 whl-action-save-address-inprogress" style="display: none;">Saving&hellip;</label>
            </div>
          </div>
        </form>
      </div>
    </div>

    <div class="modal fade" id="validateAddressModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
      aria-labelledby="validateAddressModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="validateAddressModalLabel">Validate Address</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="row mb-3">
              <div class="col-sm-12">
                <p class="lead">Please select one of the addresses below:</p>
                <div class="row bg-light text-secondary">
                  <div class="col-xs-12 col-md-1">&nbsp;</div>
                  <div class="col-xs-12 col-md-4"><small class="fw-bolder">Street Address</small></div>
                  <div class="col-xs-12 col-md-3"><small class="fw-bolder">City</small></div>
                  <div class="col-xs-12 col-md-1"><small class="fw-bolder">State</small></div>
                  <div class="col-xs-12 col-md-1"><small class="fw-bolder">Zip Code</small></div>
                  <div class="col-xs-12 col-md-2"><small class="fw-bolder">County</small></div>
                </div>
                <div class="whl-address-candidates">
                </div>
              </div>
            </div>
          </div>
          @* <div class="modal-footer">
            <button type="button" class="btn btn-secondary whl-action-cancel-validate-address" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary whl-action-confirm-validate-address">Select</button>
            <label class="whl-label-confirm-validate-address-inprogress">Saving&hellip;</label>
          </div> *@
        </div>
      </div>
    </div>
    <!-- Add script to the <head> of your page -->
    <!-- <script
      type="module"
      src="https://js.arcgis.com/embeddable-components/4.31/arcgis-embeddable-components.esm.js"
    ></script> -->
    <!-- Add custom element to <body> of your page -->
    <!-- Note: a height of 600px as a minimum is ideal -->
    <!-- <arcgis-embedded-map
      style="height:600px; width:700px;"
      item-id="a8820b3576da4729a2f6aa6440d46e9c"
      legend-enabled
      heading-disabled
      center="-73.763775000001,40.985559000003"
    >
    </arcgis-embedded-map> -->
    <!-- <arcgis-map item-id="a8820b3576da4729a2f6aa6440d46e9c" center="-73.763775000001,40.985559000003">
      <arcgis-zoom position="top-left"></arcgis-zoom>
    </arcgis-map> -->
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    <script>
      //<![CDATA[

      const arcGisApiUrl = 'https://giswww.westchestergov.com/arcgis/rest/services/geocoding/GeocodeServer';
      const arcGisAddressCandidatesApiUrl = arcGisApiUrl + '/findAddressCandidates';
      const arcGisGeoCodeAddressesApiUrl = arcGisApiUrl + '/geocodeAddresses';
      const arcGisWebMapUrl = 'https://wcgis.maps.arcgis.com/apps/mapviewer/index.html?webmap=a8820b3576da4729a2f6aa6440d46e9c&mapOnly=true&level=16';
      const arcGisEmbedMapUrl = 'https://wcgis.maps.arcgis.com/apps/Embed/index.html?webmap=a8820b3576da4729a2f6aa6440d46e9c&level=16&legend=true';

      $(function () {

        fnToggleValidate();

        $('.whl-formfield-required-validation').on('change', function (e) {
          let v = $(this).val();
          $(e.currentTarget).removeClass('is-valid');
          $(e.currentTarget).removeClass('is-invalid');
          if (v !== undefined && v !== null && v.trim().length > 0) {
            $(e.currentTarget).addClass('is-valid');
          } else {
            $(e.currentTarget).addClass('is-invalid');
          }
          fnToggleValidate();
        });

        function fnToggleValidate() {
          $('.whl-action-validate-address').attr('disabled', 'disabled');
          let validatedCount = 0;
          $('.whl-formfield-required-validation').each(function (i, elem) {
            let v = $(elem).val();
            if (v !== undefined && v !== null && v.trim().length > 0) {
              validatedCount++;
            }
          });

          if (validatedCount > 0) {
            $('.whl-action-validate-address').removeAttr('disabled');
          }
        }

        function fnSanitize(v) {
          if (v === undefined || v === null) v = '';
          return v.trim();
        }

        $('.whl-action-validate-address').on('click', function (e) {
          const streetLine1 = fnSanitize($('.whl-formfield-streetline1').val());
          const streetLine2 = fnSanitize($('.whl-formfield-streetline2').val());
          const streetLine3 = fnSanitize($('.whl-formfield-streetline3').val());
          const city = fnSanitize($('.whl-formfield-city').val());
          const state = fnSanitize($('.whl-formfield-state').val());
          const zipCode = fnSanitize($('.whl-formfield-zipcode').val());

          let addressParts = 'Address=' + encodeURIComponent(streetLine1);
          if (streetLine2.length > 0) addressParts += '&Address2=' + encodeURIComponent(streetLine2);
          if (streetLine3.length > 0) addressParts += '&Address3=' + encodeURIComponent(streetLine3);
          if (city.length > 0) addressParts += '&City=' + encodeURIComponent(city);
          if (state.length > 0) addressParts += '&Region=' + encodeURIComponent(state);
          if (zipCode.length === 5) addressParts += '&Postal=' + encodeURIComponent(zipCode);

          $('.whl-address-candidates').html('<li>None</li>');
          
          const addressCandidatesUrl = arcGisAddressCandidatesApiUrl + '?' + addressParts + '&outFields=*&f=pjson';
          $.get(addressCandidatesUrl)
            .done(function (response) {
              console.debug(response);
              let liHtml = '';
              const candidates = JSON.parse(response).candidates;
              addressCandidates = [];
              let addressCtr = 0;
              $(candidates).each(function (i, elem) {
                const singleLine = fnSanitize(elem.address);
                const streetAddress1 = fnSanitize(elem.attributes.StAddr);
                const streetAddress2 = fnSanitize(elem.attributes.SubAddr);
                const streetAddress = streetAddress1 + (streetAddress2.length > 0 ? (', ' + streetAddress2) : '');
                const city = fnSanitize(elem.attributes.City);
                const region = fnSanitize(elem.attributes.Region);
                const regionAbbr = fnSanitize(elem.attributes.RegionAbbr);
                const state = regionAbbr.length == 2 ? regionAbbr : region;
                const zipCode = fnSanitize(elem.attributes.Postal);
                const subRegion = fnSanitize(elem.attributes.Subregion);
                const county = subRegion.length > 0 ? subRegion : 'Other';
                const longitude = fnSanitize('' + elem.location.x);
                const latitude = fnSanitize('' + elem.location.y);
                if (elem.score > 80.0 && county.length > 0) {
                  addressCandidates.push({ id: addressCtr, singleLine: singleLine, streetLine1: streetAddress1, streetLine2: streetAddress2, city: city, state: state, zipCode: zipCode, county: county, longitude: longitude, latitude: latitude, x: elem.location.x, y: elem.location.y });
                  liHtml += '<div class="row">'
                            + '<div class="col-xs-12 col-md-1"><small><a href="javascript:void(0);" class="whl-link whl-address-candidate" title="' + elem.address + '" onclick="return fnSelectAddress('+ addressCtr +')">SELECT</a></small></div>'
                            + '<div class="col-xs-12 col-md-4"><small>' + streetAddress + '</small></div>'
                            + '<div class="col-xs-12 col-md-3"><small>' + city + '</small></div>'
                            + '<div class="col-xs-12 col-md-1"><small>' + state + '</small></div>'
                            + '<div class="col-xs-12 col-md-1"><small>' + zipCode + '</small></div>'
                            + '<div class="col-xs-12 col-md-2"><small>' + county + '</small></div>'
                            + '</div>';
                  addressCtr++;
                }
                //liHtml += '<li><a href="javascript:void(0);" class="whl-link whl-address-candidate" title="' + elem.address + '" onclick="return fnSelectAddress('+ i +')">' + elem.address + '</a></li>';
              });
              if (liHtml.length === 0) liHtml += '<div class="row"><div class="col-xs-12">None</div></div>';
              $('.whl-address-candidates').html(liHtml);
              $('#validateAddressModal').modal('show');
            })
            .fail(function (err) {
              console.error(err);
            });
        });

        $('.whl-action-save-address').on('click', function (e) {
          $('.whl-action-cancel-address').hide();
          $('.whl-action-save-address').hide();
          $('.whl-action-reset-address').hide();
          $('.whl-action-save-address-inprogress').show();
          return false;
        });

        $('.whl-action-reset-address').on('click', function (e) {
          $('#frmTestArcGIS')[0].reset();
          $('.whl-action-cancel-address').show();
          $('.whl-action-validate-address').show();
          $('.whl-action-save-address').hide();
          $('.whl-action-reset-address').hide();
          $('.whl-action-save-address-inprogress').hide();
          $('.whl-formfield-required-validation').removeClass('is-valid');
          $('.whl-formfield-required-validation').removeClass('is-invalid');
          $('.whl-formfield-required-save').removeClass('is-valid');
          $('.whl-formfield-required-save').removeClass('is-invalid');
          $('.whl-iframe-address-map').attr('src', '');
          $('.whl-iframe-address-map').hide();
          fnToggleValidate();
        });

        $('.whl-formfield-maptype').on('change', function (e) {
          fnSetMapUrl();
        });

      });

      let addressCandidates = [];
      let selectedAddress = {};

      function fnSetMapUrl() {
        const mapType = $('input[name="rdoMapType"]:checked').val();
        if (mapType === 'WEBMAP') {
          $('.whl-iframe-address-map').attr('src', arcGisWebMapUrl + '&marker=' + selectedAddress.longitude + ',' + selectedAddress.latitude + '&center=' + selectedAddress.longitude + ',' + selectedAddress.latitude + '');
        } else {
          $('.whl-iframe-address-map').attr('src', arcGisEmbedMapUrl + '&marker=' + selectedAddress.x + ';' + selectedAddress.y + '&center=' + selectedAddress.longitude + ',' + selectedAddress.latitude + '');
        }
      }

      function fnSelectAddress(i) {
        selectedAddress = addressCandidates[i];
        console.debug(selectedAddress);
        $('.whl-formfield-streetline1').val(selectedAddress.streetLine1);
        $('.whl-formfield-streetline2').val(selectedAddress.streetLine2);
        $('.whl-formfield-city').val(selectedAddress.city);
        $('.whl-formfield-state').val(selectedAddress.state);
        $('.whl-formfield-zipcode').val(selectedAddress.zipCode);
        $('.whl-formfield-county').val(selectedAddress.county);
        $('.whl-formfield-latitude').val(selectedAddress.latitude);
        $('.whl-formfield-longitude').val(selectedAddress.longitude);
        $('.whl-address-candidates').html('<div class="row"><div class="col-xs-12">None</div></div>');
        $('#validateAddressModal').modal('hide');
        $('.whl-action-validate-address').hide();
        $('.whl-action-save-address').show();
        $('.whl-action-reset-address').show();
        $('.whl-formfield-required-validation').removeClass('is-valid');
        $('.whl-formfield-required-validation').removeClass('is-invalid');
        $('.whl-formfield-required-save').removeClass('is-valid');
        $('.whl-formfield-required-save').removeClass('is-invalid');
        $('.whl-formfield-required-save').addClass('is-valid');
        $('.whl-iframe-address-map').show();
        fnSetMapUrl();
        return false;
      }

      //]]>
    </script>
  </body>
</html>